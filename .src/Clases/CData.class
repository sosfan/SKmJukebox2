' Gambas class file

'
' Authors:
'  J. Francisco Facundo <sos.sempai@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; version 3.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
' ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
' details.
'
' You should have received a copy of the GNU General Public License along with
' this program; if not, write to the Free Software Foundation, Inc.,
' 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

Property getConfigData As Result
Property MoneyValue As Integer
Property MoneyValue2 As Integer
Property CreditValue As Integer
Property CreditValue2 As Integer
Property CreditValue2_2 As Integer
Property CreditValue2_3 As Integer
Property CreditValue2_4 As Integer
Property CreditValue2_5 As Integer
Property MasterVol As Integer
Property ScrollString As String
Property FullScreen As Boolean
Property HideCursor As Boolean
Property ScreenSaver As Boolean
Property VideoOut As Boolean
Property AutoPlay As Boolean
Property AutoScroll As Boolean
Property MaxCreditKey As String
Property MaxCreditKey2 As String
Property MinCreditKey As String
Property ConfigKey As String
Property CancelKey As String
Property MaxVolKey As String
Property MinVolKey As String
Property MusicDir As String
Property VideoDir As String
Property KaraokeDir As String
Property CacheVideoDir As String
Property Total_credito As Integer
Property Total_credito2 As Integer
Property Credito As Integer
' Property channels As Integer[]
Property Skm_Modo As String ''Establece o retorna el modo de busqueda.
Property DBPlayList As Song ''Establece o retorna un elemento a la PlayList en la base de datos.
Property SkinTheme As String ''Establece o retorna el nombre de piel seleccionada.
Property SkinPath As String ''Retorna el path de skins
Property FtpEnable As Boolean
Property FTPHost As String ''Retorna o establece la dirección del FTPServer cuando es usado para el envio de vídeos en TVOUT.
Property FTPUser As String ''Retorna o establece el usuario establecido para la conexión en el FTPServer.
Property FTPPassword As String '' Retorna o establece la contraseña para la conexión en el FTPerver.
Private sEncrypt As New EasyEncrypt
Private Modo As String
Private Total_Album As Integer
Private hConn As Connection

Private Function ConectarBase() As Boolean
  
  If hConn Then Return False
  hConn = New Connection
  hConn.Host = User.Home
  hConn.Name = "music_db.sqlite"
  hConn.Type = "sqlite3"
  Try hConn.Open
  If Error Then
    hConn = Null
    Message.Error("Error al conectar con la bd.")
    Return True
  Endif
  Catch
    Message.Error("Error desconocido al conectar con la bd.")
  Return False
  
End

Private Function CerrarConexion()
  
  If hConn = Null Then Return
  hConn.Close
  hConn = Null
  
End

Public Sub _new()
  
  If Not Exist(User.Home &/ "music_db.sqlite") Then
    MDatabase.CreateDatabase
    ConectarBase
    With MDatabase
      .ConfigCreateDatabaseTables(hConn)
      ' .EQCreateDatabaseTables(hConn)
      .dlCreateDatabaseTables(hConn)
      .MusicaCreateDatabaseTables(hConn)
      .VideoCreateDatabaseTables(hConn)
      .KaraokeCreateDatabaseTables(hConn)
      .MonederoCreateDatabaseTables(hConn)
      .PlayListCreateDatabaseTables(hConn)
    End With
    CerrarConexion
  Endif
  ConectarBase
  
  ' Canal y fuerza para el cifrado.
  With sEncrypt
    .Channel = 2
    .Strong = 1
  End With
  
  Catch
    Debug "Database error."
  
End

Public Sub UpMusicTb()
  
  If Exist(MusicDir_Read()) Then
    
    With hConn
      .Exec("drop table abc_data")
      .Exec("drop table album_id")
      .Exec("drop table mp3")
      .Exec("drop table mp3playhistory")
      .Exec("drop table mp3albumplayhistory")
    End With
    
    MDatabase.MusicaCreateDatabaseTables(hConn)
    Exec ["skmdbmgr", "-musica"] Wait
    Last.Enabled = False
    
  Else
    
    Message.Error("\nLa ruta especificada de Música no existe, se ha movido o eliminado.\nEspecifique una nueva ruta.")
    
  Endif
  
End

Public Sub UpVideoTb()
  
  If Exist(VideoDir_Read()) Then
    
    With hConn
      .Exec("drop table video_abc_data")
      .Exec("drop table video_album_id")
      .Exec("drop table video")
      .Exec("drop table videoalbumplayhistory")
      .Exec("drop table videoplayhistory")
    End With
    
    MDatabase.VideoCreateDatabaseTables(hConn)
    Exec ["skmdbmgr", "-video"] Wait
    Last.Enabled = False
    
  Else
    
    Message.Error("\nLa ruta especificada de vídeos no existe, se ha movido o eliminado.\nEspecifique una nueva ruta.")
    
  Endif
  
End

Public Sub UpKaraokeTb()

  If Exist(KaraokeDir_Read()) Then
    
  With hConn
      .Exec("drop table karaoke_abc_data")
      .Exec("drop table karaoke_album_id")
      .Exec("drop table karaoke")
      .Exec("drop table karaokealbumplayhistory")
      .Exec("drop table karaokeplayhistory")
    End With
    
    MDatabase.KaraokeCreateDatabaseTables(hConn)
    Exec ["skmdbmgr", "-karaoke"] Wait
    Last.Enabled = False
    
  Else
    
    Message.Error("\nLa ruta especificada de Karaokes no existe, se ha movido o eliminado.\nEspecifique una nueva ruta.")
    
  Endif
  
End


Private Function getConfigData_Read() As Result

  Dim hResult As Result
  
  hResult = hConn.Exec("select * from config_data where id=1")
  
  Return hResult

End

Private Sub getConfigData_Write(Value As Result)

  Debug "Read Only " & Value

End

Private Function MoneyValue_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select MoneyValue from config_data where id=1")
  Return hResult["MoneyValue"]

End

Private Sub MoneyValue_Write(Value As Integer)

  hConn.Exec("update config_data set MoneyValue=" & Value & " where id=1")

End

Private Function MoneyValue2_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select MoneyValue2 from config_data where id=1")
  Return hResult["MoneyValue2"]

End

Private Sub MoneyValue2_Write(Value As Integer)

  hConn.Exec("update config_data set MoneyValue2=" & Value & " where id=1")

End

Private Function CreditValue_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue from config_data where id=1")
  Return hResult["CreditValue"]

End

Private Sub CreditValue_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue=" & Value & " where id=1")

End

Private Function CreditValue2_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue2 from config_data where id=1")
  Return hResult["CreditValue2"]

End

Private Sub CreditValue2_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue2=" & Value & " where id=1")

End

Private Function CreditValue2_2_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue2_2 from config_data where id=1")
  Return hResult["CreditValue2_2"]

End

Private Sub CreditValue2_2_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue2_2=" & Value & " where id=1")

End

Private Function CreditValue2_3_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue2_3 from config_data where id=1")
  Return hResult["CreditValue2_3"]

End

Private Sub CreditValue2_3_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue2_3=" & Value & " where id=1")

End

Private Function CreditValue2_4_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue2_4 from config_data where id=1")
  Return hResult["CreditValue2_4"]

End

Private Sub CreditValue2_4_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue2_4=" & Value & " where id=1")

End

Private Function CreditValue2_5_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select CreditValue2_5 from config_data where id=1")
  Return hResult["CreditValue2_5"]

End

Private Sub CreditValue2_5_Write(Value As Integer)

  hConn.Exec("update config_data set CreditValue2_5=" & Value & " where id=1")

End

Private Function MasterVol_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select MasterVol from config_data where id=1")
  Return hResult["MasterVol"]

End

Private Sub MasterVol_Write(Value As Integer)

  hConn.Exec("update config_data set MasterVol=" & Value & " where id=1")

End

Private Function FullScreen_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select FullScreen from config_data where id=1")
  Return hResult["FullScreen"]

End

Private Sub FullScreen_Write(Value As Boolean)

  hConn.Exec("update config_data set FullScreen='" & Value & "' where id=1")

End

Private Function HideCursor_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select HideCursor from config_data where id=1")
  Return hResult["HideCursor"]

End

Private Sub HideCursor_Write(Value As Boolean)

  hConn.Exec("update config_data set HideCursor='" & Value & "' where id=1")

End

Private Function ScreenSaver_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select ScreenSaver from config_data where id=1")
  Return hResult["ScreenSaver"]

End

Private Sub ScreenSaver_Write(Value As Boolean)

  hConn.Exec("update config_data set ScreenSaver='" & Value & "' where id=1")

End

Private Function VideoOut_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select VideoOut from config_data where id=1")
  Return hResult["VideoOut"]

End

Private Sub VideoOut_Write(Value As Boolean)
  
  hConn.Exec("update config_data set VideoOut='" & Value & "' where id=1")
  
End

Private Function AutoPlay_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select AutoPlay from config_data where id=1")
  Return hResult["AutoPlay"]

End

Private Sub AutoPlay_Write(Value As Boolean)

  hConn.Exec("update config_data set AutoPlay='" & Value & "' where id=1")

End

Private Function AutoScroll_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select AutoScroll from config_data where id=1")
  Return hResult["AutoScroll"]

End

Private Sub AutoScroll_Write(Value As Boolean)

  hConn.Exec("update config_data set AutoScroll='" & Value & "' where id=1")

End

Private Function MaxCreditKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MaxCreditKey from config_data where id=1")
  Return hResult["MaxCreditKey"]

End

Private Sub MaxCreditKey_Write(Value As String)

  hConn.Exec("update config_data set MaxCreditKey='" & Value & "' where id=1")

End

Private Function MaxCreditKey2_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MaxCreditKey2 from config_data where id=1")
  Return hResult["MaxCreditKey2"]

End

Private Sub MaxCreditKey2_Write(Value As String)

  hConn.Exec("update config_data set MaxCreditKey2='" & Value & "' where id=1")

End

Private Function MinCreditKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MinCreditKey from config_data where id=1")
  Return hResult["MinCreditKey"]

End

Private Sub MinCreditKey_Write(Value As String)

  hConn.Exec("update config_data set MinCreditKey='" & Value & "' where id=1")

End

Private Function ConfigKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select ConfigKey from config_data where id=1")
  Return hResult["ConfigKey"]

End

Private Sub ConfigKey_Write(Value As String)

  hConn.Exec("update config_data set ConfigKey='" & Value & "' where id=1")

End

Private Function CancelKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select CancelKey from config_data where id=1")
  Return hResult["CancelKey"]

End

Private Sub CancelKey_Write(Value As String)

  hConn.Exec("update config_data set CancelKey='" & Value & "' where id=1")

End

Private Function MaxVolKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MaxVolKey from config_data where id=1")
  Return hResult["MaxVolKey"]

End

Private Sub MaxVolKey_Write(Value As String)

  hConn.Exec("update config_data set MaxVolKey='" & Value & "' where id=1")

End

Private Function MinVolKey_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MinVolKey from config_data where id=1")
  Return hResult["MinVolKey"]

End

Private Sub MinVolKey_Write(Value As String)

  hConn.Exec("update config_data set MinVolKey='" & Value & "' where id=1")

End

Private Function MusicDir_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select MusicDir from config_data where id=1")
  Return hResult["MusicDir"]

End

Private Sub MusicDir_Write(Value As String)

  hConn.Exec("update config_data set MusicDir='" & Value & "' where id=1")

End

Private Function VideoDir_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select VideoDir from config_data where id=1")
  Return hResult["VideoDir"]

End

Private Sub VideoDir_Write(Value As String)

  hConn.Exec("update config_data set VideoDir='" & Value & "' where id=1")

End

Private Function KaraokeDir_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select KaraokeDir from config_data where id=1")
  Return hResult["KaraokeDir"]

End

Private Sub KaraokeDir_Write(Value As String)

  hConn.Exec("update config_data set KaraokeDir='" & Value & "' where id=1")

End

Private Function Total_credito_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select Total_credito from monedero where id=1")
  Return hResult["Total_credito"]

End

Private Sub Total_credito_Write(Value As Integer)

  hConn.Exec("update monedero set Total_credito=" & Value & " where id=1")

End

Private Function Total_credito2_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select Total_credito2 from monedero where id=1")
  Return hResult["Total_credito2"]

End

Private Sub Total_credito2_Write(Value As Integer)

  hConn.Exec("update monedero set Total_credito2=" & Value & " where id=1")

End

Private Function Credito_Read() As Integer

  Dim hResult As Result
  
  hResult = hConn.Exec("select Credito from monedero where id=1")
  Return hResult["Credito"]

End

Private Sub Credito_Write(Value As Integer)

  hConn.Exec("update monedero set Credito=" & Value & " where id=1")

End

' Private Function channels_Read() As Integer[]
' 
'   Dim hResult As Result, ch As New Integer[], i As Integer
'   hResult = hConn.Exec("select * from EQ_data where id=1")
'   For i = 1 To 10
'     ch.Push(hResult[i & "ch"])
'   Next
'   Return ch
' 
' End
' 
' Private Sub channels_Write(Value As Integer[])
' 
'   Dim i As Integer
'   
'   For i = 1 To 10
'     hConn.Exec("update EQ_data set " & i & "ch=" & Value[i - 1] & " where id=1")
'   Next
' 
' End

Private Sub delAccents(Value As String) As String
  
  Dim sVal As String
  
  sVal = "replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(" & Value & ",'Á','A'),'á','a'),'É','E')," &
         "'é','e'),'Í','I'),'í','i'),'Ó','O'),'ó','o'),'Ú','U'),'ú','u')"
  
  Return sVal
  
End

Public Sub getDataSearch($Modo As Byte, tSearch As Byte, sSearch As String) As Result ''Devuelve 30 busquedas 1=Musica 2=Videos 3=Karaokes 4=Todos 6=Mas tocados

  Dim hResult As Result, i, b As Byte, sCons, sTab, sAlb As String
  
  Select $Modo
    Case 1
      If tSearch = 1 Then
        For i = 1 To 25
          sCons = sCons & "Select C.id, Album, Cover_name, Genero, Tipo, O.id, N" & i & " " &
                  "From album_id C, mp3 O Where(C.Songsid1 = O.id Or C.Songsid2 = O.id Or C.Songsid3 = O.id Or C.Songsid4 = O.id) And " &
                  "" & delAccents("N" & i) & "  Like '%" & sSearch & "%' "
          If i = 25 Then
            sCons = sCons & "limit 100"
            Break
          Endif
          sCons = sCons & "union all "
        Next
        hResult = hConn.Exec(sCons)
      Else
        hResult = hConn.Exec("select * from album_id where " & delAccents("Album") & " Like '%" & sSearch & "%' limit 50")
      Endif
      
    Case 2
      If tSearch = 1 Then
      For i = 1 To 25
          sCons = sCons & "Select C.id, Album, Cover_name, Genero, Tipo, O.id, N" & i & " " &
                  "From video_album_id C, video O Where(C.Songsid1 = O.id Or C.Songsid2 = O.id Or C.Songsid3 = O.id Or C.Songsid4 = O.id) And " &
                  "" & delAccents("N" & i) & "  Like '%" & sSearch & "%' "
          If i = 25 Then
            sCons = sCons & "limit 100"
            Break
          Endif
          sCons = sCons & "union all "
        Next
        hResult = hConn.Exec(sCons)
      Else
        hResult = hConn.EXEC("select * from video_album_id where " & delAccents("Album") & " Like '%" & sSearch & "%' limit 50")
      Endif
    Case 3
      If tSearch = 1 Then
      For i = 1 To 25
          sCons = sCons & "Select C.id, Album, Cover_name, Genero, Tipo, O.id, N" & i & " " &
                  "From karaoke_album_id C, karaoke O Where(C.Songsid1 = O.id Or C.Songsid2 = O.id Or C.Songsid3 = O.id Or C.Songsid4 = O.id) And " &
                  "" & delAccents("N" & i) & "  Like '%" & sSearch & "%' "
          If i = 25 Then
            sCons = sCons & "limit 100"
            Break
          Endif
          sCons = sCons & "union all "
        Next
        hResult = hConn.Exec(sCons)
      Else
        hResult = hConn.EXEC("select * from karaoke_album_id where " & delAccents("Album") & " Like '%" & sSearch & "%' limit 50")
      Endif
    Case 4
      If tSearch = 1 Then
        For b = 1 To 3
          Select b
            Case 1
              sTab = "mp3"
              sAlb = "album_id"
            Case 2
              sTab = "video"
              sAlb = "video_album_id"
            Case 3
              sTab = "karaoke"
              sAlb = "karaoke_album_id"
          End Select
          For i = 1 To 25
              sCons = sCons & "Select C.id, Album, Cover_name, Genero, Tipo, O.id, N" & i & " " &
                      "From " & sAlb & " C, " & sTab & " O Where(C.Songsid1 = O.id Or C.Songsid2 = O.id Or C.Songsid3 = O.id Or C.Songsid4 = O.id) And " &
                      "" & delAccents("N" & i) & "  Like '%" & sSearch & "%' "
              If i = 25 Then
                Break
              Endif
              sCons = sCons & "union all "
          Next
          If b = 3 Then
            sCons = sCons & " limit 100 "
            Break
          Else
            sCons = sCons & "union all "
          Endif
        Next
        hResult = hConn.Exec(sCons)
      Else
        hResult = hConn.EXEC("select * from album_id where " & delAccents("Album") & " like '%" & sSearch & "%' union " &
        "select * From video_album_id where " & delAccents("Album") & " Like '%" & sSearch & "%' union " &
        "select * From karaoke_album_id where " & delAccents("Album") & " Like '%" & sSearch & "%' limit 50")
      Endif
    'Case "MasTocado"
    'Case "Nuevos"
  End Select
  Return hResult

End
' Select * From "album_id" where "Genero" Like "Vocaloid"
Public Sub getAllIDInfo(sGenre As String) As Result
  
  Dim hResult As Result
  If sGenre = "*" Then
    Select Modo
      Case "Musica"
        hResult = hConn.Exec("select id from album_id")
      Case "Video"
        hResult = hConn.EXEC("select id from video_album_id")
      Case "Karaoke"
        hResult = hConn.EXEC("select id from karaoke_album_id")
      'Case "MasTocado"
      'Case "Nuevos"
    End Select
  Else
    Select Modo
      Case "Musica"
        hResult = hConn.Exec("select id from album_id where Genero Like '" & sGenre & "'")
      Case "Video"
        hResult = hConn.EXEC("select id from video_album_id where Genero Like '" & sGenre & "'")
      Case "Karaoke"
        hResult = hConn.EXEC("select id from karaoke_album_id where Genero Like '" & sGenre & "'")
      'Case "MasTocado"
      'Case "Nuevos"
    End Select
  Endif
  Return hResult
  
End

Public Sub getDataAlbum(Contador As Short) As Result ''Devueve 1 busqueda
  
  Dim hResult As Result
  Select Modo
    Case "Musica"
      hResult = hConn.Exec("select * from album_id where id=" & contador)
    Case "Video"
      hResult = hConn.EXEC("select * from video_album_id where id=" & contador)
    Case "Karaoke"
      hResult = hConn.EXEC("select * from karaoke_album_id where id=" & contador)
    'Case "MasTocado"
    'Case "Nuevos"
  End Select
  Return hResult
  
End

Public Sub getDataSongs(Contador As Short) As Result
  
  Dim hResult As Result
  Select Modo
    Case "Musica"
      hResult = hConn.Exec("select * from mp3 where id=" & contador)
    Case "Video"
      hResult = hConn.EXEC("select * from video where id=" & contador)
    Case "Karaoke"
      hResult = hConn.EXEC("select * from karaoke where id=" & contador)
    'Case "MasTocado"
    'Case "Nuevos"
  End Select
  Return hResult
  
End
' Select DISTINCT "Genero" From "album_id"
Public Sub getGenres(Value As String) As Result
  
  Dim hResult As Result
  
  Select Value
    Case "Musica"
      hResult = hConn.Exec("Select DISTINCT Genero From album_id")
    Case "Video"
      hResult = hConn.Exec("Select DISTINCT Genero From video_album_id")
    Case "Karaoke"
      hResult = hConn.Exec("Select DISTINCT Genero From karaoke_album_id")
  End Select
  
  Return hResult
  
End
' select * from "album_id" where "Genero" like "musica septiembre 2018" AND "Album" like "l%" Limit 1
Public Sub getIdJump(sGenre As String, Value As String) As Integer ''Retorna el valor de ID de album al saltar en el NavKey
  
  Dim hResult As Result
  
  If sGenre = "*" Then
    Select Modo
      Case "Musica"
        hResult = hConn.Exec("Select id From album_id where Album like '" & Value & "%' Limit 1")
      Case "Video"
        hResult = hConn.Exec("Select id From video_album_id where Album like '" & Value & "%' Limit 1")
      Case "Karaoke"
        hResult = hConn.Exec("Select id From karaoke_album_id where Album like '" & Value & "%' Limit 1")
    End Select
  Else
    Select Modo
      Case "Musica"
        hResult = hConn.Exec("Select id From album_id where Genero Like '" & sGenre & "' AND Album like '" & Value & "%' Limit 1")
      Case "Video"
        hResult = hConn.Exec("Select id From video_album_id where Genero Like '" & sGenre & "' AND Album like '" & Value & "%' Limit 1")
      Case "Karaoke"
        hResult = hConn.Exec("Select id From karaoke_album_id where Genero Like '" & sGenre & "' AND Album like '" & Value & "%' Limit 1")
    End Select
  Endif
  
  If hResult.Count > 0 Then
    Return hResult["id"]
  Endif
  
End

Public Sub getAllPlaylist() As Integer '' Retorna la longitud de la cola de reproducción.
  
  Dim hResult As Result
  
  hResult = hConn.Exec("select * from playlist")
  Return hResult.Length
  
End

Private Function DBPlayList_Read() As Song

  Dim hResult As Result, sData As New Song
'   
  hResult = hConn.Exec("select * from playlist")
  hResult.MoveFirst
  
  If hResult.Length > 0 Then
    With sData
      .ID_video = hResult["IDVideo"]
      .URL_image = hResult["URLImage"]
      .album = hResult["Album"]
      .name = hResult["Nombre"]
      .genre = hResult["Genero"]
      .type = hResult["Tipo"]
      .cover = hResult["Cover"]
    End With
  Endif
  
  Return sData

End

Private Sub DBPlayList_Write(sData As Song)

  Dim hResult As Result
  
  hResult = hConn.Exec("select max(id) from playlist")
  If hResult["max(id)"] = Null Then
    hConn.Exec("insert into playlist values (&1,&2,&3,&4,&5,&6,&7,&8,&9)", 1, Null, sData.ID_video, sData.URL_image, sData.album, sData.name, sData.genre, sData.type, sData.cover)
  Else
    hConn.Exec("insert into playlist values (&1,&2,&3,&4,&5,&6,&7,&8,&9)", hResult["max(id)"] + 1, Null, sData.ID_video, sData.URL_image, sData.album, sData.name, sData.genre, sData.type, sData.cover)
  Endif

End

Public Sub getWorkDir() As String
  
  Dim WorkDir As String
  Select Modo
    Case "Musica"
      WorkDir = MusicDir_Read()
    Case "Video"
      WorkDir = VideoDir_Read()
    Case "Karaoke"
      WorkDir = KaraokeDir_Read()
  End Select
  Return WorkDir
  
End

Public Sub DelFirstItemPL() ''Elimina la primera entrada en la DB playlist
  
  Dim hResult As Result
'   
  hResult = hConn.Exec("select * from playlist")
  hResult.MoveFirst
  Try hConn.Exec("delete from playlist where id=" & hResult["id"])
  
End

Private Function Skm_Modo_Read() As String

  Return Modo

End

Private Sub Skm_Modo_Write(Value As String)
  
  Value = UCase(Left(Value)) & Right(Value, -1)
  Modo = Value

End

Private Sub LoadTotalAlbum(sGenre As String)
  
  Dim hResult As Result
  If sGenre = "*" Then
      Select Case Modo
        Case "Musica"
          hResult = hConn.Exec("select id from album_id")
        Case "Video"
          hResult = hConn.Exec("select id from video_album_id")
        Case "Karaoke"
          hResult = hConn.Exec("select id from karaoke_album_id")
      End Select
  Else
      Select Case Modo
        Case "Musica"
          hResult = hConn.Exec("select id from album_id where Genero Like '" & sGenre & "'")
        Case "Video"
          hResult = hConn.Exec("select id from video_album_id where Genero Like '" & sGenre & "'")
        Case "Karaoke"
          hResult = hConn.Exec("select id from karaoke_album_id where Genero Like '" & sGenre & "'")
      End Select
  Endif
  
  Total_Album = hResult.Count
  If Total_Album > 0 Then Inc Total_Album
  
End

Public Sub getTotalAlbums(sGenre As String) As Integer

  LoadTotalAlbum(sGenre)
  Return Total_Album
  
End

Public Sub setPlayHistory(sSong As Song)

  Dim hResult As Result, i, id, idAlbum, idSong, nsong As Integer, nModo As String
  
  idAlbum = sSong.idalbum
  idSong = sSong.id
  nsong = sSong.idsong
  
  If idAlbum = 0 Then Return
  
  Select sSong.type
    Case "musica"
      nModo = "mp3"
    Case "video"
      nModo = "video"
    Case "karaoke"
      nModo = "karaoke"
  End Select

  hResult = hConn.Exec("select * from " & nModo & "albumplayhistory where id=" & idAlbum)
  If hResult.Available = False Then
    hConn.Exec("insert into " & nModo & "albumplayhistory values (&1,&2)", idAlbum, 1)
  Else
    i = hResult["Contador"]
    Inc i
    hConn.Exec("update " & nModo & "albumplayhistory set Contador=" & i & " where id=" & idAlbum)
  Endif
  
  hResult = hConn.Exec("select * from " & nModo & "playhistory where idalbum=" & idAlbum & " AND idsong=" & idSong & " AND N=" & nsong)
  
  If hResult.Available = False Then 
    hResult = hConn.Exec("select * from " & nModo & "playhistory")
    id = hResult.Count + 1
    hConn.Exec("insert into " & nModo & "playhistory values (&1,&2,&3,&4,&5,&6)",
    id, idalbum, idsong, sSong.type, nsong, 1)
  Else
    id = hResult["id"]
    i = hResult["Contador"]
    Inc i
    hConn.Exec("update " & nModo & "playhistory set Contador=" & i & " where id=" & id)
  Endif
  
End

Public Sub setCacheDownload(sSong As Song)
  
  Dim hResult As Result, i As Integer
  
  hResult = hConn.Exec("Select * from ytdl_data")
  
  If hResult.Available = False Then
    i = 1
  Else 
    hResult.MoveLast
    i = hResult["id"] + 1
    
    If hResult.Count > 99 Then
      If sSong.ID_video <> hResult["ytID"] Then 
        hResult = hConn.Exec("select * from playlist where IDVideo='" & hResult["ytID"] & "'")
        If hResult.Available = False Then
          DelFirstItemCacheDl
        Endif
      Endif
    Endif
    
  Endif
  
  hConn.Exec("Insert into ytdl_data values (&1,&2,&3)", i, sSong.ID_video, sSong.name)
  
End

Public Sub DelFirstItemCacheDl()
  
  Dim hResult As Result, CacheDir, ytID As String
  
  CacheDir = CacheVideoDir_Read()
  hResult = hConn.Exec("Select * from ytdl_data")
  
  If hResult.Available = True Then 
    If hResult.Count > 0 Then
    
      hResult.MoveFirst
      ytID = hResult["ytID"]
      
      hConn.Exec("Delete from ytdl_data where id=" & hResult["id"])
      Try Kill CacheDir &/ ytID & ".mp4"
      Debug CacheDir &/ ytID & ".mp4"
    Endif 
  Endif 
  
End

Public Sub getIdPlayHistory() As Result
  
  Dim hResult As Result
  
  hResult = hConn.Exec("select * from mp3playhistory union select * from videoplayhistory union select * from karaokeplayhistory" &
  " order by Contador DESC Limit 100")
  
  Return hResult
  
End

Public Sub getPlayHistory() As Result
  
  Dim idResult, hResult As Result, sCons, sTab, sAlb As String, i As Integer
  
  idResult = getIdPlayHistory()
  
  For i = 0 To idResult.Max
    Select idResult["type"]
      Case "musica"
        sTab = "mp3"
        sAlb = "album_id"
      Case "video"
        sTab = "video"
        sAlb = "video_album_id"
      Case "karaoke"
        sTab = "karaoke"
        sAlb = "karaoke_album_id"
    End Select
    sCons = sCons & "Select C.id, Album, Cover_name, Genero, Tipo, N" & idResult["N"] & " From " & sAlb & " C, " & sTab & " O " &
            "Where(C.Songsid1 = O.id Or C.Songsid2 = O.id Or C.Songsid3 = O.id Or C.Songsid4 = O.id) and O.id='" & idResult["idsong"] & "'"
    idResult.MoveNext
    If i <> idResult.Max Then sCons = sCons & " Union All "
  Next
  If i > 0 Then hResult = hConn.Exec(sCons)
  
  Return hResult
  
End

Private Function SkinTheme_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select Theme from config_data where id=1")
  Return hResult["Theme"]

End

Private Sub SkinTheme_Write(Value As String)

  hConn.Exec("update config_data set Theme='" & Value & "' where id=1")

End

Private Function SkinPath_Read() As String
  
  Dim path As String
  path = "/usr/share/skmjukebox/skins/"
  ' path = User.Home & "/skins/"
  Return path
  
End

Private Sub SkinPath_Write(Value As String)
  
  Debug Value
  
End

Private Function FtpEnable_Read() As Boolean

  Dim hResult As Result
  
  hResult = hConn.Exec("select FtpEnable from config_data where id=1")
  Return hResult["FtpEnable"]

End

Private Sub FtpEnable_Write(Value As Boolean)

  hConn.Exec("update config_data set FtpEnable='" & Value & "' where id=1")

End

Private Function FTPHost_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select FtpHost from config_data where id=1")
  Return hResult["FtpHost"]

End

Private Sub FTPHost_Write(Value As String)

  hConn.Exec("update config_data set FtpHost='" & Value & "' where id=1")

End

Private Function FTPUser_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select FtpUser from config_data where id=1")
  Return hResult["FtpUser"]

End

Private Sub FTPUser_Write(Value As String)

  hConn.Exec("update config_data set FtpUser='" & Value & "' where id=1")

End

Private Function FTPPassword_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("select FtpPassword from config_data where id=1")
  
  Return sEncrypt.TextOfuscate(hResult["FtpPassword"], False, "")

End

Private Sub FTPPassword_Write(Value As String)

  hConn.Exec("update config_data set FtpPassword='" & sEncrypt.TextOfuscate(Value, True, "") & "' where id=1")

End

Private Function ScrollString_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("Select ScrollString from config_data where id=1")
  
  Return hResult["ScrollString"]

End

Private Sub ScrollString_Write(Value As String)

  hConn.Exec("Update config_data set ScrollString='" & Value & "' where id=1")

End

Private Function CacheVideoDir_Read() As String

  Dim hResult As Result
  
  hResult = hConn.Exec("Select CacheVideoDir from config_data where id=1")
  
  Return hResult["CacheVideoDir"]

End

Private Sub CacheVideoDir_Write(Value As String)

  hConn.Exec("Update config_data set CacheVideoDir='" & Value & "' where id=1")

End

Public Sub GetCacheDownload() As Result
  
  Dim hResult As Result
  
  hResult = hConn.Exec("Select * from ytdl_data")
  
  Return hResult
  
End

Public Sub SearchCacheID(ytID As String) As Boolean
  
  Dim hResult As Result
  
  hResult = hConn.Exec("Select * from ytdl_data where ytID='" & ytID & "'")
  
  Return hResult.Available
  
End
